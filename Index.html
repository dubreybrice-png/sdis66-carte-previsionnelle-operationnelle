<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SDIS 66 â€” Carte PrÃ©visionnelle OpÃ©rationnelle</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #1a1a2e;
      color: #eee;
      overflow: hidden;
    }

    /* â”€â”€ HEADER â”€â”€ */
    #header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(135deg, #c0392b, #e74c3c);
      padding: 8px 20px;
      z-index: 2000;
      position: relative;
      box-shadow: 0 2px 10px rgba(0,0,0,.3);
    }
    #header h1 { font-size: 1.1rem; font-weight: 600; letter-spacing: .3px; }
    #header .badge {
      background: rgba(255,255,255,.2);
      padding: 3px 10px;
      border-radius: 10px;
      font-size: .75rem;
    }

    /* â”€â”€ CARTE â”€â”€ */
    #map { width: 100%; height: calc(100vh - 44px); }

    /* â”€â”€ LOADING â”€â”€ */
    #loading {
      position: fixed; inset: 0;
      display: flex; align-items: center; justify-content: center;
      flex-direction: column; gap: 12px;
      background: #1a1a2e; z-index: 9999;
      font-size: 1rem;
    }
    .spinner {
      width: 36px; height: 36px;
      border: 4px solid rgba(231,76,60,.3);
      border-top-color: #e74c3c;
      border-radius: 50%;
      animation: spin .7s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg); } }

    /* â”€â”€ LÃ‰GENDE â”€â”€ */
    .legend {
      position: absolute;
      bottom: 20px; left: 10px;
      background: rgba(26,26,46,.92);
      padding: 14px 18px;
      border-radius: 12px;
      z-index: 2000;
      font-size: .78rem;
      line-height: 1.6;
      box-shadow: 0 4px 16px rgba(0,0,0,.4);
    }
    .legend strong { display: block; margin-bottom: 6px; font-size: .85rem; }
    .legend-row { display: flex; align-items: center; gap: 8px; }
    .legend-color {
      width: 14px; height: 14px; border-radius: 50%; flex-shrink: 0;
      border: 2px solid rgba(255,255,255,.5);
    }

    /* â”€â”€ CONTRÃ”LES â”€â”€ */
    .controls {
      position: absolute; top: 54px; left: 10px;
      z-index: 2000;
      display: flex; flex-direction: column; gap: 5px;
    }
    .ctrl-btn {
      background: rgba(26,26,46,.9);
      color: #fff;
      border: 1px solid rgba(255,255,255,.15);
      padding: 6px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: .78rem;
      transition: all .2s;
    }
    .ctrl-btn:hover { background: #e74c3c; }
    .ctrl-btn.active { background: #c0392b; border-color: #e74c3c; }

    /* â”€â”€ SIDEBAR â”€â”€ */
    #sidebar {
      position: absolute;
      top: 54px; right: 10px;
      width: 340px;
      max-height: calc(100vh - 74px);
      background: rgba(26,26,46,.95);
      border-radius: 12px;
      padding: 16px;
      overflow-y: auto;
      z-index: 2000;
      box-shadow: 0 4px 20px rgba(0,0,0,.5);
      display: none;
    }
    #sidebar.visible { display: block; }
    #sidebar h2 {
      font-size: .95rem; margin-bottom: 8px; color: #e74c3c;
    }
    .info-row {
      display: flex; justify-content: space-between;
      padding: 5px 0;
      border-bottom: 1px solid rgba(255,255,255,.08);
      font-size: .82rem;
    }
    .info-row .label { color: #999; }
    .info-row .value { font-weight: 600; }
    .taux-bar {
      height: 8px; border-radius: 4px; margin-top: 8px;
      background: #2c3e50; overflow: hidden;
    }
    .taux-fill {
      height: 100%; border-radius: 4px;
      transition: width .4s ease;
    }
    #sidebar .close-btn {
      position: absolute; top: 8px; right: 12px;
      background: none; border: none; color: #aaa;
      font-size: 1.1rem; cursor: pointer;
    }
    #sidebar .close-btn:hover { color: #fff; }

    /* â”€â”€ TOOLTIP pour marqueurs â”€â”€ */
    .leaflet-tooltip.centre-tooltip {
      background: rgba(26,26,46,.9);
      color: #fff;
      border: 1px solid rgba(255,255,255,.2);
      border-radius: 6px;
      padding: 6px 10px;
      font-size: .78rem;
      font-weight: 500;
      box-shadow: 0 2px 8px rgba(0,0,0,.3);
    }
    .leaflet-tooltip.centre-tooltip::before { border-top-color: rgba(26,26,46,.9); }

    /* â”€â”€ MARKER label â”€â”€ */
    .marker-label {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      white-space: nowrap;
      font-size: 10px;
      font-weight: 700;
      color: #2c3e50;
      text-shadow: 0 0 3px #fff, 0 0 3px #fff, 0 0 3px #fff, 0 0 3px #fff;
      pointer-events: none;
      margin-top: 2px;
    }
  </style>
</head>
<body>

<!-- Loading -->
<div id="loading">
  <div class="spinner"></div>
  <span>Chargement de la carteâ€¦</span>
</div>

<!-- Header -->
<div id="header">
  <h1>ğŸ—ºï¸ SDIS 66 â€” Carte PrÃ©visionnelle OpÃ©rationnelle</h1>
  <span class="badge" id="badge-info">Chargementâ€¦</span>
</div>

<!-- Map -->
<div id="map"></div>

<!-- Controls -->
<div class="controls">
  <button class="ctrl-btn active" onclick="toggleGroupement('Nord',this)">ğŸ”µ Nord</button>
  <button class="ctrl-btn active" onclick="toggleGroupement('Ouest',this)">ğŸŸ£ Ouest</button>
  <button class="ctrl-btn active" onclick="toggleGroupement('Sud',this)">ğŸŸ  Sud</button>
  <button class="ctrl-btn" onclick="toggleLabels(this)" id="btnLabels">ğŸ·ï¸ Noms</button>
</div>

<!-- LÃ©gende -->
<div class="legend">
  <strong>LÃ©gende</strong>
  <div class="legend-row">
    <svg width="28" height="28" viewBox="0 0 28 28">
      <defs>
        <clipPath id="lg-l"><polygon points="0,0 28,28 0,28"/></clipPath>
        <clipPath id="lg-r"><polygon points="0,0 28,0 28,28"/></clipPath>
      </defs>
      <circle cx="14" cy="14" r="12" fill="#27ae60" clip-path="url(#lg-l)"/>
      <circle cx="14" cy="14" r="12" fill="#e67e22" clip-path="url(#lg-r)"/>
      <circle cx="14" cy="14" r="12" fill="none" stroke="#fff" stroke-width="1.5"/>
      <line x1="0" y1="0" x2="28" y2="28" stroke="#fff" stroke-width="1.5"/>
    </svg>
    <span>Actuel <span style="color:#27ae60">â– </span> / Cible <span style="color:#e67e22">â– </span></span>
  </div>
  <div class="legend-row"><div class="legend-color" style="background:#3498db"></div> Groupement Nord</div>
  <div class="legend-row"><div class="legend-color" style="background:#9b59b6"></div> Groupement Ouest</div>
  <div class="legend-row"><div class="legend-color" style="background:#e67e22"></div> Groupement Sud</div>
</div>

<!-- Sidebar -->
<div id="sidebar">
  <button class="close-btn" onclick="closeSidebar()">âœ•</button>
  <h2 id="sb-title"></h2>
  <div id="sb-content"></div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Ã‰TAT GLOBAL
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var map;
var markersPerGroupement = { Nord: [], Ouest: [], Sud: [] };
var groupementVisible    = { Nord: true, Ouest: true, Sud: true };
var allMarkers = [];
var labelsVisible = false;
var centresData = [];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SVG â€” CERCLE COUPÃ‰ EN DIAGONALE
   MoitiÃ© gauche (bas-gauche) = vert = effectif actuel
   MoitiÃ© droite (haut-droite) = orange = effectif cible
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildSplitSVG(actuel, cible, size) {
  size = size || 44;
  var half = size / 2;
  var r    = half - 3;

  // Couleur de la bordure selon groupement : on le passe pas ici,
  // on utilise blanc pour garder la lisibilitÃ©
  var uid = 'c' + Math.random().toString(36).substr(2, 6);

  var greenColor  = '#27ae60';
  var orangeColor = '#e67e22';
  var grayColor   = '#7f8c8d';

  // Si pas de cible dÃ©finie, cercle gris
  if (!cible || cible <= 0) {
    return '<svg width="'+size+'" height="'+size+'" viewBox="0 0 '+size+' '+size+'">'
      + '<circle cx="'+half+'" cy="'+half+'" r="'+r+'" fill="'+grayColor+'" opacity=".5" stroke="#fff" stroke-width="2"/>'
      + '<text x="'+half+'" y="'+(half+4)+'" text-anchor="middle" fill="#fff" font-size="12" font-weight="bold">'
      + actuel + '</text></svg>';
  }

  var taux = cible > 0 ? actuel / cible : 0;
  // Vert plus ou moins saturÃ© selon le taux
  if (taux >= 1) greenColor = '#1e8449';

  var svg = '<svg width="'+size+'" height="'+size+'" viewBox="0 0 '+size+' '+size+'">'
    + '<defs>'
    + '<clipPath id="L'+uid+'"><polygon points="0,0 '+size+','+size+' 0,'+size+'"/></clipPath>'
    + '<clipPath id="R'+uid+'"><polygon points="0,0 '+size+',0 '+size+','+size+'"/></clipPath>'
    + '</defs>'
    // MoitiÃ© gauche = vert (actuel)
    + '<circle cx="'+half+'" cy="'+half+'" r="'+r+'" fill="'+greenColor+'" clip-path="url(#L'+uid+')"/>'
    // MoitiÃ© droite = orange (cible)
    + '<circle cx="'+half+'" cy="'+half+'" r="'+r+'" fill="'+orangeColor+'" clip-path="url(#R'+uid+')"/>'
    // Bordure
    + '<circle cx="'+half+'" cy="'+half+'" r="'+r+'" fill="none" stroke="#fff" stroke-width="2"/>'
    // Diagonale
    + '<line x1="0" y1="0" x2="'+size+'" y2="'+size+'" stroke="#fff" stroke-width="2"/>'
    // Nombre gauche (actuel)
    + '<text x="'+(half - r/2.2)+'" y="'+(half + 5)+'" text-anchor="middle" fill="#fff" font-size="11" font-weight="bold">'
    + actuel + '</text>'
    // Nombre droite (cible)
    + '<text x="'+(half + r/2.2)+'" y="'+(half + 1)+'" text-anchor="middle" fill="#fff" font-size="11" font-weight="bold">'
    + cible + '</text>'
    + '</svg>';

  return svg;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INITIALISATION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function init() {
  google.script.run
    .withSuccessHandler(function(config) {
      initMap(config);
      chargerDonnees();
    })
    .withFailureHandler(function() {
      initMap({ center:{lat:42.58, lng:2.55}, zoom:10 });
      chargerDonnees();
    })
    .getMapConfig();
}

function initMap(config) {
  map = L.map('map', {
    center: [config.center.lat, config.center.lng],
    zoom: config.zoom || 10,
    zoomControl: true
  });

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap | SDIS 66',
    maxZoom: 18
  }).addTo(map);

  document.getElementById('loading').style.display = 'none';
}

function chargerDonnees() {
  google.script.run
    .withSuccessHandler(function(data) {
      centresData = data || [];
      renderCentres(centresData);

      var total = centresData.reduce(function(s,c){ return s + c.effectifActuel; }, 0);
      document.getElementById('badge-info').textContent = total + ' ISP â€” ' + centresData.length + ' centres';
    })
    .withFailureHandler(function(err) {
      console.error('Erreur chargement:', err);
      document.getElementById('badge-info').textContent = 'Erreur chargement';
    })
    .getCarteData();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDU DES CENTRES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderCentres(centres) {
  centres.forEach(function(c) {
    if (!c.lat || !c.lng) return;

    // Taille du cercle selon importance
    var size = 44;
    if (c.effectifCible >= 20) size = 52;
    else if (c.effectifCible >= 10) size = 48;
    else if (!c.effectifCible) size = 36;

    var svgHtml = buildSplitSVG(c.effectifActuel, c.effectifCible, size);

    var icon = L.divIcon({
      className: '',
      html: svgHtml + '<div class="marker-label" style="display:none">' + c.nom + '</div>',
      iconSize: [size, size + 16],
      iconAnchor: [size / 2, size / 2]
    });

    var marker = L.marker([c.lat, c.lng], { icon: icon });

    // Tooltip
    var taux = c.effectifCible > 0
      ? Math.round((c.effectifActuel / c.effectifCible) * 100) + '%'
      : 'â€”';
    marker.bindTooltip(
      '<strong>' + c.nom + '</strong> (' + c.groupement + ')<br>'
      + 'Actuel : <b style="color:#27ae60">' + c.effectifActuel + '</b> Â· '
      + 'Cible : <b style="color:#e67e22">' + (c.effectifCible || 'â€”') + '</b> Â· '
      + 'Taux : <b>' + taux + '</b>',
      { className: 'centre-tooltip', direction: 'top', offset: [0, -size/2 + 4] }
    );

    // Clic â†’ sidebar
    marker.on('click', function() { showSidebar(c); });

    marker.addTo(map);
    marker._centreData = c;
    allMarkers.push(marker);
    if (markersPerGroupement[c.groupement]) {
      markersPerGroupement[c.groupement].push(marker);
    }
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIDEBAR DÃ‰TAIL CENTRE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showSidebar(c) {
  var sb = document.getElementById('sidebar');
  document.getElementById('sb-title').textContent = 'ğŸ›ï¸ ' + c.nom;

  var taux = c.effectifCible > 0 ? Math.round((c.effectifActuel / c.effectifCible) * 100) : 0;
  var ecart = c.effectifCible > 0 ? c.effectifCible - c.effectifActuel : 0;
  var tauxColor = taux >= 100 ? '#27ae60' : taux >= 75 ? '#f39c12' : '#e74c3c';

  var html = ''
    + infoRow('Groupement', c.groupement)
    + infoRow('Effectif actuel', '<span style="color:#27ae60;font-size:1.1em">' + c.effectifActuel + '</span>')
    + infoRow('Effectif cible', '<span style="color:#e67e22;font-size:1.1em">' + (c.effectifCible || 'â€”') + '</span>')
    + infoRow('Taux de couverture', '<span style="color:'+tauxColor+';font-size:1.1em">' + taux + '%</span>');

  if (ecart > 0) {
    html += infoRow('Postes Ã  pourvoir', '<span style="color:#e74c3c;font-weight:700">' + ecart + '</span>');
  } else if (ecart <= 0 && c.effectifCible > 0) {
    html += infoRow('Statut', '<span style="color:#27ae60">âœ… Complet</span>');
  }

  // Barre de progression
  html += '<div class="taux-bar"><div class="taux-fill" style="width:' + Math.min(taux, 100)
    + '%;background:' + tauxColor + '"></div></div>';

  // CoordonnÃ©es
  html += '<div style="margin-top:12px;font-size:.72rem;color:#666">'
    + 'ğŸ“ ' + c.lat.toFixed(4) + ', ' + c.lng.toFixed(4) + '</div>';

  document.getElementById('sb-content').innerHTML = html;
  sb.classList.add('visible');
}

function closeSidebar() {
  document.getElementById('sidebar').classList.remove('visible');
}

function infoRow(label, value) {
  return '<div class="info-row"><span class="label">' + label
    + '</span><span class="value">' + value + '</span></div>';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONTRÃ”LES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleGroupement(grp, btn) {
  groupementVisible[grp] = !groupementVisible[grp];
  btn.classList.toggle('active');

  markersPerGroupement[grp].forEach(function(m) {
    if (groupementVisible[grp]) {
      m.addTo(map);
    } else {
      map.removeLayer(m);
    }
  });
}

function toggleLabels(btn) {
  labelsVisible = !labelsVisible;
  btn.classList.toggle('active');
  var display = labelsVisible ? 'block' : 'none';
  document.querySelectorAll('.marker-label').forEach(function(el) {
    el.style.display = display;
  });
}

// Fermer sidebar en cliquant sur la carte
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('map').addEventListener('click', function(e) {
    if (e.target.classList.contains('leaflet-container') ||
        e.target.classList.contains('leaflet-tile')) {
      closeSidebar();
    }
  });
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LANCEMENT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
init();
</script>
</body>
</html>
